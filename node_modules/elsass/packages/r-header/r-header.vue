<template>
  <Header class="r-header">
    <Row>
      <Col span="2" align="center" class="col-global-btn" ref="global-btn">
        <div class="ib">
          <a @click="$emit('on-global-menu')">
            <!-- <Icon type="ios-menu-outline" size="32" /> -->
            <div class="r-a-div">
              <RIcon icon-class="icon-global-function" class="r-global-function-icon"/>
            </div>
          </a>
        </div>
      </Col>
      <Col span="3" class="title col-logo">
        <div @click="$emit('click-rcc-logo')" class="r-rcc-logo ib">
          <img src="../../src/assets/images/rcc.png">
        </div>
        <div @click="$emit('click-rcc-logo')" class="r-system-logo ib">
          <img :src="sysImg ? sysImg : require('../../src/assets/images/elsass.png')">
        </div>
      </Col>
      <Col v-if="show_menus && show_menus.length > 0" :span="$slots.default ? 13 : 17" class="col-menus" ref="col-menus">
        <Menu mode="horizontal" class="header-menus" v-if="menus.length>0" style="position:absolute;width:calc(100% - 110px);">
          <template v-for="menu in show_menus">
            <MenuItem :name="menu.name" :key="menu.name" v-if="!menu.children || menu.children.length==0">
              <router-link :to="menu.path" v-if="menu.type=='router'">
                <Icon :type="menu.icon" v-if="menu.icon" />{{menu.title}}
              </router-link>
              <a :href="menu.path" v-else-if="menu.type=='link'" target="_blank">
                <Icon :type="menu.icon" v-if="menu.icon" />
                {{menu.title}}
              </a>
              <span v-else>{{menu.title}}</span>
            </MenuItem>
            <Submenu :name="menu.name" v-else-if="menu.children && menu.children.length>0" :key="menu.name">
              <template slot="title">
                <Icon :type="menu.icon" v-if="menu.icon" />
                {{menu.title}}
              </template>  
              <template v-for="sub_menu in menu.children">
                <MenuItem :name="sub_menu.name" :key="sub_menu.name">
                  <router-link :to="sub_menu.path" v-if="sub_menu.type=='router'">
                    <Icon :type="sub_menu.icon" v-if="sub_menu.icon" />{{sub_menu.title}}
                  </router-link>
                  <a :href="sub_menu.path" v-else-if="sub_menu.type=='link'" target="_blank">
                    <Icon :type="sub_menu.icon" v-if="sub_menu.icon" />{{sub_menu.title}}
                  </a>
                  <span v-else>{{sub_menu.title}}</span>
                </MenuItem>
              </template>
            </Submenu>
          </template>
        </Menu>
        <span v-else>&nbsp;</span> 
        <div class="btn-con" v-if="show_menu_length<menus.length">
          <Button type="text" @click="menu_back" v-if="start_menu_index>0"><Icon type="ios-arrow-back" size="18" /></Button>
          <Button type="text" @click="menu_forward" v-if="start_menu_index+show_menu_length<menus.length"><Icon type="ios-arrow-forward" size="18"/></Button>
        </div>
      </Col>
      <Col :span="show_menus && show_menus.length > 0 ? 4 : 17" :class="align" class="col-search" v-if="$slots.default">
        <slot></slot>
      </Col>
      <Col span="1" align="center" class="col-message">
        <Badge dot :count="newMessage">
          <a @click="$emit('on-message-list')">
            <RIcon icon-class="icon-horn" />
          </a>
        </Badge>
      </Col>
      <Col span="1" align="center" class="col-user" :title="userName">
        <Dropdown @on-click="handleDropDown" :title="userName">
          <img v-if="userImage" class="user-icon" :src="userImage" :title="userName">
          <RIcon v-else icon-class="icon-my" :title="userName"/>
          <!-- <span v-if="userName" :title="userName">{{showName}}</span> -->
          <Icon size="18" type="md-arrow-dropdown"></Icon>
          <DropdownMenu slot="list">
            <DropdownItem v-for="drop in drops" :name="drop.name" :key="`r-persion-drop-${drop.name}`">{{drop.title}}</DropdownItem>
          </DropdownMenu>
        </Dropdown>
      </Col>
    </Row>
  </Header>
</template>
<script>
import RIcon from '../r-icon/r-icon.vue'
export default {
  name: 'RHeader',
  props: { 
    // title: { type: String, required: true}, // 左侧系统名称
    menus: { type: Array, default: () => { return [] } }, // 头部菜单
    newMessage: { type: Number, default: 0}, //新消息数量
    sysImg: { type: String }, // 系统图标图片
    drops: {type: Array, default: () => { return [
      { name: 'personal-page', title: '个人信息'},
      { name: 'logout', title: '退出登录'}
    ] } },
    userImage: {type: String}, // 用户头像
    userName: {type: String}, // 用户名称
    align: {
      type: String,
      default: 'right',
      validator (value) {
        return ['right', 'left', 'center'].includes(value)
      }
    }
  },
  data () {
    return {
      start_menu_index: 0,
      show_menus: [],
      show_menu_length: 0
    }
  },
  methods: {
    handleDropDown (name) {
      this.$emit('on-handle-drop', {name: name})
    },
    calc_menus () {
      let end_menu_index = 0
      end_menu_index = this.start_menu_index + this.show_menu_length
      if (end_menu_index >= this.menus.length) {
        end_menu_index = this.menus.length
        this.start_menu_index = this.menus.length - this.show_menu_length
      }
      this.show_menus = this.menus.slice(this.start_menu_index, end_menu_index)
    },
    menu_back () {
      this.start_menu_index = this.start_menu_index - 1
      this.calc_menus()
    },
    menu_forward () {
      this.start_menu_index = this.start_menu_index + 1
      this.calc_menus()
    },
    // span=12或16 的长度，像素值
    all_menu_width () {
      // return parseInt(this.$refs['col-menus'].$el.offsetWidth)
      let span = 12
      let col_width = this.$refs['global-btn'].$el.offsetWidth/2-1
      if (!this.$slots.default) { span = 16 }
      return parseInt(col_width * span)
    },
    // 可以显示下的菜单项数
    menu_show_length () {
      let menu_length = 0
      let menu_width = 0
      this.menus.forEach((v, i) => {
        menu_width += 40 // 两边padding宽度
        if (v.icon) {
          menu_width = menu_width + 20 // icon宽度
        }
        menu_width = menu_width + v.title.length * 14
        if (v.children) {
          menu_width = menu_width + 22
        }
        if (menu_width < this.all_menu_width()) {
          menu_length = menu_length + 1
        }
      })
      this.show_menu_length = menu_length
    },
    // 长度是否超出 span=12
    over_length () {
      this.show_menu_length < this.menus.length
    }
  },
  mounted () {
    this.menu_show_length() // 设置要显示的菜单数
    this.calc_menus() // 计算要显示的菜单
  },
  computed: {
    showName () {
      return this.userName ? this.userName.slice(4) : null
    }
  },
  components: {
    RIcon
  }
}
</script>