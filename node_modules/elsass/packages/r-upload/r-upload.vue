<template>
  <div>
    <!-- 附件上传 -->
    <Upload
      v-bind="$props"
      :action="action"
      :data="resData"
      :show-upload-list="false"
    >
      <Button icon="ios-cloud-upload-outline">上传文件</Button>
    </Upload>

    <!-- 附件列表展示 -->
    <RFilesShow
      v-if="showFileList"
      :filesList = "filesList"
      @dropFile = "dropFile"
    ></RFilesShow>
  </div>

</template>

<script>
import dateUtils from '../../util/date.js'
import UAFormat from '../../util/ua-format'
import {Upload} from 'iview'
import RFilesShow from '../r-files-show/r-files-show.vue'
let crypto = require('crypto')
export default {
  name: 'RUpload',
  data () {
    return {}
  },
  extends: Upload,
  props: {
    ...Upload.props,
    // 附件上传地址
    action: {
      type: String,
      default () {
        return ''
      }
    },
    formData: {
      type: Object,
      default () {
        return {}
      }
    },
    filesList: {
      type: Array,
      default () {
        return []
      }
    },
    secretKey: {
      type: String,
      default: ''
    },
    secretIv: {
      type: String,
      default: ''
    },
    showFileList: {
      type: Boolean,
      default: true
    }
  },
  components: {
    RFilesShow,
    Upload
  },
  methods: {
    dropFile: function (index) {
      this.$emit('dropFile', index)
    },
    // 加密
    crypt (src, key = this.secretKey, iv = this.secretIv) {
      let sign = ''
      let algorithm = 'aes-256-ctr'
      const cipher = crypto.createCipheriv(algorithm, key, iv)
      sign += cipher.update(src, 'utf8', 'base64')
      sign += cipher.final('base64')
      return sign
    }
  },
  computed: {
    resData () {
      if (this.secretKey) {
        const date = new Date()
        const dateFormate = dateUtils.formate_date(date, 'YYYY-MM-DD hh:mm:ss')
        let res = Object.assign({
          timestamp: dateFormate,
          sign: this.crypt(dateFormate)
        }, this.formData)
        return res
      } else {
        return this.formData
      }
    }
  }
}
</script>

<style scoped>
  .files-list {
    border: 1px solid #E3E3E3;
    display: inline-block;
  }
  .files-list .file-info {
    width: 170px;
    height: 163px;
    margin: 9px 6px 9px 9px;
    float: left;
    padding: 4px 6px;
  }
  .files-list .file-info:hover {
    border: 1px solid #999999;
  }
  .files-list .file-img {
    width: 155px;
    height: 111px;
    margin: 6px 7px;
    border: 1px solid #E3E3E3;
    text-align: center;
    display: table-cell
  }
  .files-list .file-name {
    text-align: center;
    float: left;
    margin-left: 8px;
    width: 155px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  .file-delete-img {
    width: 11px;
    height: 15px;
    float: right;
    margin: 0 2px 2px 0px;
  }
  .file-img img {
    margin: 15px 30px;
  }
</style>
