<template>
  <RDialog
    :title="title"
    :value="value"
    @on-close="$emit('change', false)">
    <div class="r-feedback">
      <div class="r-feedback-inner">
        <div class="r-feedback-switch">
          <label>
            <input name="firm" type="radio" value="FIRM" :checked="target === 'FIRM'" @click="target = 'FIRM'" />
            <span>向公司高层提意见/建议 </span>
          </label> 
          <label>
            <input name="it" type="radio" value="IT" :checked="target === 'IT'" @click="target = 'IT'" />
            <span>向IT部反馈系统问题/建议 </span>
          </label> 
        </div>
        <div class="r-feedback-input">
          <RRichText :doc-content="docContent" :toolbar="toolbar" :action="action" :formData="dealFormData"
                  :placeholder="placeholder" @on-editor-change="editor_change"></RRichText>
        </div>
        <div class="r-feedback-operate">
          <div class="r-feedback-notice" v-show="showNotice">请输入有效字符进行反馈！</div>
          <button class="primary-btn" @click="confirm_feedback">确定发送</button>
          <button @click="$emit('change', false)" >取消</Button>
        </div>
      </div>
    </div>
  </RDialog>
</template>

<script>
import RDialog from '../../packages/r-dialog/r-dialog'
import RRichText from '../../packages/r-rich-text/r-rich-text'
import dateUtils from '../../util/date.js'
import UAFormat from '../../util/ua-format'
import feedbackApis from '../../src/apis/modules/feedback.js'
import fetch from '../../src/apis/fetch/index.js'
let crypto = require('crypto')
export default {
  name: 'RFeedback',
  props: {
    title: {
      type: String,
      default: '员工反馈'
    },
    value: {
      type: Boolean,
      default: false
    },
    action: {
      type: String,
      default: 'http://rccfile.rccchina.com/upload'
    },
    feedbackaction: {
      type: String,
      default: 'http://feedback.rccchina.com/feedback'
    },
    formData: {
      type: Object,
      default () {
        return {}
      }
    }, // 上传图片相关参数
    feedbackData: {
      type: Object,
      default () {
        return {}
      }
    }, // 反馈参数
    feedbackdata: {
      type: String
    }, // 反馈参数，js引入的项目中使用
    placeholder: {
      type: String,
      default: '请输入您想要反馈的意见与建议（可通过复制粘贴或者拖拽添加图片），您的反馈我们会安排专人处理，3个工作日内给您回复。'
    },
    secretKey: {
      type: String,
      default: 'd6F3Efeqd6F3Efeqd6F3Efeqd6F3Efeq'
    },
    secretIv: {
      type: String,
      default: '1234567890123456'
    }
  },
  model:{
    prop: 'value',
    event: 'change'  // 自定义方法，用来更新 model
  },
  data () {
    return {
      docContent: '',
      toolbar: {
        container: [
          ['bold', 'italic', 'underline', 'strike'],        // 加粗 斜体 下划线 删除线
          ['blockquote', 'code-block']
        ]
      },
      target: '',
      showNotice: false
    }
  },
  computed: {
    dealFormData () {
      const date = new Date()
      const dateFormate = dateUtils.formate_date(date, 'YYYY-MM-DD hh:mm:ss')
      let res = Object.assign({
        timestamp: dateFormate,
        sign: this.crypt(dateFormate)
      }, this.formData)
      return res
    }
  },
  methods: {
    // 匹配是否符合格式
    match_content (str) {
      const htmlReg = /<.+?>/g
      const strReg = /[\u4e00-\u9fa5a-zA-Z0-9]/g
      const reg = str.replace(htmlReg, '').match(strReg)
      return reg && reg.length >= 2
    },
    // 编辑器修改
    editor_change (args) {
      this.showNotice = false
      let dom = document.querySelector('.ql-editor')
      dom.style.border = ''
      this.docContent = args.content
    },
    // 确定发送
    async confirm_feedback () {
      if (!this.target || this.target === '') {
        alert('请选择您想将反馈发送至哪个信箱。')
        return false
      }
      const inReg = this.match_content(this.docContent)
      if (!this.docContent || !inReg) {
        let dom = document.querySelector('.ql-editor')
        dom.style.border = '1px solid red'
        this.showNotice = true
        return false
      }
      let formater = new UAFormat()
      const date = new Date()
      const dateFormate = dateUtils.formate_date(date, 'YYYY-MM-DD hh:mm:ss')
      const browser = formater.getBrowser()
      const os = formater.getOS()
      let data = {}
      if (this.feedbackdata) {
        data = JSON.parse(this.feedbackdata)
      } else {
        data = this.feedbackData
      }
      const params = {
        ...data,
        timestamp: dateFormate,
        sign: this.crypt(dateFormate),
        content: this.docContent,
        web_browser: (browser.name || '浏览器未知') + ' ' + (browser.version || '版本未知'),
        system: (os.name || '系统未知') + ' ' + (os.version || '版本未知'),
        mail_box: this.target,
        source_url: document.location.href,
        http_referer: document.referrer
      }
      let res = await fetch({path: this.feedbackaction}, params)
      if (res.code === 10000) {
        alert('感谢您的反馈，我们已安排专人处理，会在3个工作日内给您回复。同时该邮件也会发送到您的企业邮箱方便您查找。')
        this.$emit('confirm_feedback', params)
        this.target = ''
        this.docContent = ''
        this.$emit('change', false)
      } else if (res.code === 1) {
        alert(res.message)
      } else {
        alert('反馈失败，请联系客服')
      }
    },
    // 加密
    crypt (src, key = this.secretKey, iv = this.secretIv) {
      let sign = ''
      let algorithm = 'aes-256-ctr'
      const cipher = crypto.createCipheriv(algorithm, key, iv)
      sign += cipher.update(src, 'utf8', 'base64')
      sign += cipher.final('base64')
      return sign
    },
    // 解密
    encrypt (text) {
      if (!text) {
        return ''
      }
      let algorithm = 'aes-256-ctr'
      let password = 'd6F3Efeqd6F3Efeqd6F3Efeqd6F3Efeq'
      let piv = '1234567890123456'
      try {
        let cipher = crypto.createDecipheriv(algorithm, password, piv)
        let crypted = cipher.update(text, 'base64', 'utf8')
        crypted += cipher.final('utf8')
        return crypted
      } catch (e) {
        console.log(e)
      }
    }
  },
  components: {
    RDialog,
    RRichText
  }
}
</script>

<style lang="sass" scoped>
.r-feedback
  height: 500px
  width: 600px
  .r-feedback-inner
    padding: 0 20px
    height: inherit
    .r-feedback-switch
      height: 50px
      label
        vertical-align: middle
        line-height: 50px
        input
          vertical-align: baseline
        span
          margin-left: 10px
          vertical-align: middle
        &:not(last-child)
          margin-right: 30px
    .r-feedback-input
      height: calc(100% - 130px)
    .r-feedback-operate
      height: 60px
      // line-height: 40px
      text-align: right
      .r-feedback-notice
        height: 16px
        line-height: 16px
        text-align: left
        color: red
      button
        text-align: center
        padding: 5px 8px
        min-width: 20px
        color: #50545e
        background-color: #f1f1f1
        cursor: pointer
        line-height: normal
        border-radius: 4px
        &:not(last-child)
          margin-right: 8px
        &.primary-btn
          color: #fff
          background-color: #008de5
</style>