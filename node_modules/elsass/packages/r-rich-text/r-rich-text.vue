<template>
  <div style="height: 100%">
    <quill-editor
     v-model="content"
     :options="editorOption"
     @change="onEditorChange"
     style="height: calc(100% - 50px)"
    ></quill-editor>
  </div>
</template>

<script>
import 'quill/dist/quill.core.css'
import 'quill/dist/quill.snow.css'
import 'quill/dist/quill.bubble.css'
import { quillEditor, Quill } from 'vue-quill-editor'
// import { ImageDrop } from 'quill-image-drop-module'
import {ImageExtend, QuillWatch} from 'quill-image-extend-module'
// import ImageResize from 'quill-image-resize-module'
const Font = Quill.import('formats/font')
window.Quill = require('quill/dist/quill.js')
Font.whitelist = ['serif', 'monospace', 'Arial', '宋体', '黑体', '微软雅黑']
Quill.register(Font, true)
// Quill.register('modules/imageDrop', ImageDrop)
// Quill.register('modules/imageResize', ImageResize)
Quill.register('modules/ImageExtend', ImageExtend)
export default {
  name: 'RRichText',
  data () {
    return {
      imgFiles: [],
      editorOption: {
        modules: {
          // imageDrop: true,
          toolbar: this.toolbar,
          // imageResize: {
          //   displayStyles: {
          //     backgroundColor: 'black',
          //     border: 'none',
          //     color: 'white'
          //   },
          //   modules: [ 'Resize', 'DisplaySize', 'Toolbar' ]
          // },
          ImageExtend: {
            loading: true,
            name: 'file',
            action: this.action,
            change: function (xhr, formData) {
              let _that = this
              Object.keys(this.formData).forEach((key) => {
                formData.append(key, _that.formData[key])
              })
            },
            response: (res) => {
              if (res.code >= 10000) {
                this.imgFiles.push({
                  name: res.data.file_name,
                  path: res.data.file_path,
                  host: res.data.file_host,
                  file: res
                })
                // 返回图片的地址
                return (res.data.file_host || '') + res.data.file_path
              } else if (res.code === 1) {
                alert(res.message)
                return false
              } else {
                alert(res.message)
                return false
              }
            },
            success: (res) => {
            },
            error: (res) => {
            },
            formData: this.formData,
            currentDom: this
          }
        },
        placeholder: this.placeholder
      },
      content: ''
    }
  },
  props: {
    docContent: {
      type: String,
      default: ''
    },
    action: {
      type: String,
      default: ''
    }, // 上传路径
    formData: {
      type: Object,
      default () {
        return {}
      }
    }, // 上传附带参数
    toolbar: {
      type: [Object, Array],
      default () {
        return {
          container: [
            ['bold', 'italic', 'underline', 'strike'],        // 加粗 斜体 下划线 删除线
            ['blockquote', 'code-block'],                 // 引用  代码块
            [{'header': 1}, {'header': 2}],               // 1、2 级标题
            [{'list': 'ordered'}, {'list': 'bullet'}],     // 有序、无序列表
            [{'script': 'sub'}, {'script': 'super'}],      // 上标/下标
            [{'indent': '-1'}, {'indent': '+1'}],           // 缩进
            [{'direction': 'rtl'}],                         // 文本方向
            [{'size': ['small', false, 'large', 'huge']}],   // 字体大小
            [{'header': [1, 2, 3, 4, 5, 6, false]}],       // 标题
            [{'color': []}, {'background': []}],          // 字体颜色、字体背景颜色
            [{'font': ['Arial', 'serif', 'monospace', '宋体', '黑体', '微软雅黑']}],                               // 字体种类
            [{'align': []}],                              // 对齐方式
            ['image'],                                   // 链接、图片、视频
            ['clean']                                        // 清除文本格式
          ],
          handlers: {
            'image': function () {
              QuillWatch.emit(this.quill.id)
            }
          }
        }
      }
    },
    placeholder: {
      type: String,
      default: '请输入'
    }
  },
  components: {
    quillEditor
  },
  methods: {
    // 内容改变事件
    onEditorChange: function () {
      this.$emit('on-editor-change', {content: this.content, imgFiles: this.imgFiles})
    }
  },
  watch: {
    docContent: function (str) {
      this.content = str
    }
  },
  created () {
    ImageExtend.prototype.pasteHandle = function (e) {
      // e.preventDefault()
      QuillWatch.emit(this.quill.id, 0)
      let clipboardData = e.clipboardData
      let i = 0
      let items, item, types // eslint-disable-line

      if (clipboardData) {
        items = clipboardData.items;

        if (!items) {
          return;
        }
        item = items[0];
        types = clipboardData.types || [];

        for (; i < types.length; i++) {
          if (types[i] === 'Files') {
            item = items[i];
            break;
          }
        }
        if (item && item.kind === 'file' && item.type.match(/^image\//i)) {
          this.file = item.getAsFile()
          let self = this
          // 如果图片限制大小
          if (self.config.size && self.file.size >= self.config.size * 1024 * 1024) {
            if (self.config.sizeError) {
              self.config.sizeError()
            }
            return
          }
          if (this.config.action) {
            this.uploadImg()
          } else {
            this.toBase64()
          }
        }
      }
    }
  },
  activated () {
    this.content = this.docContent
  }
}
</script>

<style>
  .editor {
    line-height: normal !important;
    height: 800px;
  }
  .ql-snow .ql-tooltip[data-mode=link]::before {
    content: "请输入链接地址:";
  }
  .ql-snow .ql-tooltip.ql-editing a.ql-action::after {
      border-right: 0px;
      content: '保存';
      padding-right: 0px;
  }

  .ql-snow .ql-tooltip[data-mode=video]::before {
      content: "请输入视频地址:";
  }

  .ql-snow .ql-picker.ql-size .ql-picker-label::before,
  .ql-snow .ql-picker.ql-size .ql-picker-item::before {
    content: '14px';
  }
  .ql-snow .ql-picker.ql-size .ql-picker-label[data-value=small]::before,
  .ql-snow .ql-picker.ql-size .ql-picker-item[data-value=small]::before {
    content: '10px';
  }
  .ql-snow .ql-picker.ql-size .ql-picker-label[data-value=large]::before,
  .ql-snow .ql-picker.ql-size .ql-picker-item[data-value=large]::before {
    content: '18px';
  }
  .ql-snow .ql-picker.ql-size .ql-picker-label[data-value=huge]::before,
  .ql-snow .ql-picker.ql-size .ql-picker-item[data-value=huge]::before {
    content: '32px';
  }

  .ql-snow .ql-picker.ql-header .ql-picker-label::before,
  .ql-snow .ql-picker.ql-header .ql-picker-item::before {
    content: '文本';
  }
  .ql-snow .ql-picker.ql-header .ql-picker-label[data-value="1"]::before,
  .ql-snow .ql-picker.ql-header .ql-picker-item[data-value="1"]::before {
    content: '标题1';
  }
  .ql-snow .ql-picker.ql-header .ql-picker-label[data-value="2"]::before,
  .ql-snow .ql-picker.ql-header .ql-picker-item[data-value="2"]::before {
    content: '标题2';
  }
  .ql-snow .ql-picker.ql-header .ql-picker-label[data-value="3"]::before,
  .ql-snow .ql-picker.ql-header .ql-picker-item[data-value="3"]::before {
    content: '标题3';
  }
  .ql-snow .ql-picker.ql-header .ql-picker-label[data-value="4"]::before,
  .ql-snow .ql-picker.ql-header .ql-picker-item[data-value="4"]::before {
    content: '标题4';
  }
  .ql-snow .ql-picker.ql-header .ql-picker-label[data-value="5"]::before,
  .ql-snow .ql-picker.ql-header .ql-picker-item[data-value="5"]::before {
    content: '标题5';
  }
  .ql-snow .ql-picker.ql-header .ql-picker-label[data-value="6"]::before,
  .ql-snow .ql-picker.ql-header .ql-picker-item[data-value="6"]::before {
    content: '标题6';
  }

  .ql-snow .ql-picker.ql-font .ql-picker-label::before,
  .ql-snow .ql-picker.ql-font .ql-picker-item::before {
    content: '标准字体';
  }
  .ql-snow .ql-picker.ql-font .ql-picker-label[data-value=serif]::before,
  .ql-snow .ql-picker.ql-font .ql-picker-item[data-value=serif]::before {
    content: '衬线字体';
  }
  .ql-snow .ql-picker.ql-font .ql-picker-label[data-value=monospace]::before,
  .ql-snow .ql-picker.ql-font .ql-picker-item[data-value=monospace]::before {
    content: '等宽字体';
  }
  .ql-snow .ql-picker.ql-font .ql-picker-label[data-value='宋体']::before,
  .ql-snow .ql-picker.ql-font .ql-picker-item[data-value='宋体']::before {
      content: "宋体" !important;
      font-family: "宋体";
  }
  .ql-snow .ql-picker.ql-font .ql-picker-label[data-value='黑体']::before,
  .ql-snow .ql-picker.ql-font .ql-picker-item[data-value='黑体']::before {
      content: "黑体" !important;
      font-family: "黑体";
  }
  .ql-snow .ql-picker.ql-font .ql-picker-label[data-value='微软雅黑']::before,
  .ql-snow .ql-picker.ql-font .ql-picker-item[data-value='微软雅黑']::before {
      content: "微软雅黑" !important;
      font-family: "微软雅黑";
  }
  .ql-snow .ql-picker.ql-font .ql-picker-label[data-value='Arial']::before,
  .ql-snow .ql-picker.ql-font .ql-picker-item[data-value='Arial']::before {
      content: "Arial" !important;
      font-family: "Arial";
  }
   /*编辑器内容用*/
  .ql-font-Arial {
    font-family: "Arial";
  }
  .ql-font-宋体 {
    font-family: "SimSun";
  }
  .ql-font-黑体 {
    font-family: "SimHei";
  }
  .ql-font-微软雅黑 {
    font-family: "Microsoft YaHei";
  }
</style>

