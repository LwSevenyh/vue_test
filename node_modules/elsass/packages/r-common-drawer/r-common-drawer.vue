<template>
  <RDrawer :value="value"
      @change="change">
    <div slot="content" class="drawer-slot-content" :class="{'show-content': value}">
      <div class="drawer-header-inner">
        <div class="drawer-header-block">
          <div class="drawer-header-block-title">
            <RIcon icon-class="icon-global-function" class="r-global-function-icon"/>&nbsp;&nbsp;RCC大集成
          </div>
          <div class="drawer-header-block-content">全局页面</div>
        </div>
      </div>
      <div class="drawer-content-inner">
        <div class="drawer-search-block">
          <Input v-model="label" size="small" placeholder="全局入口搜索" @on-enter="search_label">
            <Icon type="ios-search" slot="suffix" />
          </Input>
        </div>
        <div class="drawer-content-block">
          <div class="drawer-left-panel">
            <div class="drawer-tags">
              <template v-if="tree.root">
                <div class="drawer-tag" v-for="tag in tree.root.children" :key="'tag-' + tag"
                 v-show="tree.atoms[tag].display === 1"
                :class="{'active': currentTag === tree.atoms[tag].name}" @click="change_tag(tag)" @mouseenter="change_tag(tag)">
                  <template v-if="tree.atoms[tag].options && tree.atoms[tag].options.image">
                    <img :src="tree.atoms[tag].options.image">
                  </template>
                  <template v-else>
                    <RIcon class="tag-icon" icon-class="icon-asterisk"></RIcon>
                  </template>
                </div>
              </template>
            </div>
          </div>
          <div class="drawer-right-panel">
            <template v-if="tree.root">
              <div class="drawer-tag-panel" v-for="tag in tree.root.children" v-show="currentTag === tree.atoms[tag].name" :key="'tag-panel-' + tag">
                <div class="drawer-tag-panel-header">
                  {{tree.atoms[tag].show_label}}
                </div>
                <div class="drawer-tag-panel-content">
                  <div class="drawer-tag-group-panel" v-for="group in tree.atoms[tag].children"
                   :key="'tag-group-' + tag + group" v-show="tree.atoms[group].display === 1">
                    <div class="drawer-tag-group-title">
                      {{tree.atoms[group].show_label}}
                    </div>
                    <div class="drawer-tag-group-content">
                      <div class="drawer-tag-group-item" v-for="item in tree.atoms[group].children"
                           @click="click_item(item)" :key="`tag-group-item-${item}`"
                           v-show="tree.atoms[item].display === 1 && !over_len(tree.atoms[item].label)">
                        <div class="drawer-tag-group-item-header">
                          <template v-if="tree.atoms[item].options.image">
                            <img :src="tree.atoms[item].options.image">
                          </template>
                          <template v-else>
                            <RIcon class="drawer-header-icon" icon-class="icon-company"></RIcon>
                          </template>
                          <div class="drawer-tag-group-item-icon">
                            <RIcon class="drawer-header-right-icon" icon-class="icon-star-line"
                                   :class="{'active': tree.atoms[item].status === 1}"></RIcon>
                          </div>
                        </div>
                        <div class="drawer-tag-group-item-text" v-html="tree.atoms[item].show_label">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </template>  
          </div>
        </div>
      </div>
    </div>
  </RDrawer>
</template>

<script>
import RDrawer from '../../packages/r-drawer/r-drawer'
import RIcon from '../../packages/r-icon/r-icon'
import Tree from '../../util/tree.js'
import string from '../../util/string.js'
export default {
  name: 'RCommonDrawer',
  props: {
    data: {
      type: Array,
      default () {
        return []
      }
    },
    value: {
      type: Boolean,
      default: false
    }
  },
  model:{
    prop: 'value',
    event: 'change'  // 自定义方法，用来更新 model
  },
  data () {
    return {
      currentTag: '',
      tree: {}, // 树，用于搜索
      initStatus: false, // 树的初始化状态
      label: '', // 用于搜索
      searchCount: 0
    }
  },
  methods: {
    // 关闭
    change (args) {
      this.$emit('change', args || false)
    },
    // 切换tag
    change_tag (tag) {
      this.currentTag = this.tree.atoms[tag].name
      this.$emit('change-tag', {tag: tag})
    },
    // 初始化树结构，将数据传入树
    init_tree () {
      this.initStatus = false
      let tree = new Tree()
      tree.initTree(this.data)
      this.tree = tree
      this.initStatus = true
    },
    // 搜索
    search_label () {
      this.searchCount = this.tree.searchAtomByLabel(this.label, 4)
    },
    // 判断字符串长度
    over_len (str) {
      return string.overLen(str, 15)
    },
    // 点击
    click_item (item) {
      let val = this.tree.atoms[item]
      if (val) {
        this.$emit('click-item', {options: val.options})
      } else {
        console.log('item no find')
      }
    }
  },
  mounted () {
    if (this.data && this.data[0]) {
      this.currentTag = this.data[0].name
      this.init_tree()
    }
  },
  components: {
    RDrawer,
    RIcon
  },
  watch: {
    data (newVal) {
      this.currentTag = data[0].name
      this.init_tree()
    }
  }
}
</script>

<style lang="sass">
@import '../../packages/theme-chalk/main.sass'
.drawer-slot-content
  height: 100%
  transition: width 2s
  width: 0
  overflow: hidden
  &.show-content
    width: 410px
.drawer-header-inner
  height: 85px
  text-align: center
  background: linear-gradient(135deg,$header-background-linear-left-color 0%,$header-background-linear-right-color 100%)

  .drawer-header-block
    padding: 20px
    color: #fff
    letter-spacing: 2px
    .drawer-header-block-title
      font-weight: bold
      font-size: 18px
      .icon-global-function
        color: #fff
    .drawer-header-block-content
      font-size: 14px
      margin-top: 5px
.drawer-content-inner
  width: 410px
  height: calc(100% - 85px)
  border: 1px solid #A585E5
  border-width: 0 1px 0 0
  .drawer-search-block
    @include content_bg_color
    padding: 12px 20px
  .drawer-content-block
    height: calc(100% - 50px)
    // overflow: hidden
    @include drawer_border_color  
    .drawer-left-panel
      height: 100%
      overflow-y: auto
      width: 80px
      display: inline-block
      vertical-align: top
      .drawer-tags
        overflow-x: hidden
        background-color: #fff
        height: auto
        .drawer-tag
          padding: 10px
          cursor: pointer
          text-align: center
          border-left: 6px solid transparent
          .tag-icon
            height: 40px
            width:  40px
            color: $icon-active-color
          &.active
            border-color: $border-active-color
    .drawer-right-panel
      height: calc(100% - 5px)
      overflow-y: auto
      width: calc(100% - 80px)
      display: inline-block
      vertical-align: top
      margin-top: 5px
      .drawer-tag-panel
        @include content_bg_color
        padding: 14px 0 14px 14px
        height: 100%
        .drawer-tag-panel-header
          @include content_tf_color
          font-weight: bold
          font-size: $label-font
        .drawer-tag-panel-content
          margin-top: 10px
          .drawer-tag-group-panel
            .drawer-tag-group-title
              @include content_tf_color
              font-size: $label-font
              margin: 12px 0
            .drawer-tag-group-content
              // display: flex
              // flex-wrap: wrap
              .drawer-tag-group-item
                // flex: 1
                background-color: #fff
                display: inline-block
                margin: 0 14px 14px 0
                border-radius: 4px
                .drawer-tag-group-item-header
                  padding: 15px 10px 7px 10px
                  text-align: center
                  position: relative
                  image, .drawer-header-icon
                    width: 30px
                    height: 30px
                  .drawer-tag-group-item-icon
                    position: absolute
                    right: 0
                    top: 0
                    height: 17px
                    width: 17px
                    background-color: $header-right-label-bg-color
                    border-bottom-left-radius: 10px
                    text-align: center
                    .drawer-header-right-icon
                      height: 10px
                      width: 10px
                      margin-top: 3px
                      vertical-align: top
                      &.active
                        color: $icon-active-color

                .drawer-tag-group-item-text
                  @include content_font_color
                  padding: 0 12px 12px 12px
                  .search-active
                    color: red

</style>