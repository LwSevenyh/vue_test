<template>
  <!-- 穿梭框 -->
  <div class="transfer-list">
    <!-- 左侧的备选列表 -->
    <div class="list-frame available-list">
      <!-- 标头的全选以及列表名称 -->
      <div class="list-title available-list-tile">
        <Checkbox v-model="checked_all_available_fields" @on-change="checkAll(checked_all_available_fields, 'available')">
          {{list_titles[0]}}
        </Checkbox>
      </div>
      <!-- 备选列表框 -->
      <div class="list-content available-list-content">
        <!-- 当列表框中存在列表项时 -->
        <template v-if="available_fields && available_fields.length > 0">
          <template v-for="(field, index) in available_fields">
            <!-- 单个列表项目 -->
            <div @click="selectItem(field, 'available')" class="list-item available-list-item" v-bind:key="'available-list-item' + field.label + index" :class="field.selected ? 'selected': ''">
              <!-- 是可勾选的 -->
              <template v-if="field.checkable">
                <div class="list-item-prefix available-list-item-prefix">
                  <Checkbox v-model="field.checked"></Checkbox>
                </div>
                <div class="list-item-label available-list-item-label">{{field.label}}</div>
              </template>
              <!-- 不可勾选的 -->
              <template v-else>
                <div class="list-item-prefix available-list-item-prefix">&nbsp;</div>
                <div class="list-item-label available-list-item-label">{{field.label}}</div>
              </template>
            </div>
          </template>
        </template>
        <!-- 当列表框中不存在列表项时 -->
        <template v-else>
          <div class="no-list-item available-no-list-item">
            <!-- {{$t('transfer.no_available_fields')}} -->
            没有可用的备选字段
          </div>
        </template>
      </div>
    </div>

    <!-- 中间的移动按钮面板 -->
    <div class="change-panel">
      <!-- 移除(从右向左) -->
      <Button size="small" :disabled="!(checked_specified_fields && checked_specified_fields.length > 0)" @click="moveToLeft">{{operation_labels[0]}}</Button>
      <!-- 添加(从左向右) -->
      <Button size="small" :disabled="!(checked_available_fields && checked_available_fields.length > 0)" @click="moveToRight">{{operation_labels[1]}}</Button>
    </div>

    <!-- 右侧的已选列表框 -->
    <div class="list-frame specified-list">
      <!-- 标头的全选以及列表名称 -->
      <div class="list-title specified-list-tile">
        <Checkbox v-model="checked_all_specified_fields" @on-change="checkAll(checked_all_specified_fields, 'specified')">
          {{list_titles[1]}}
        </Checkbox>
      </div>
      <!-- 已选列表框 -->
      <div class="list-content specified-list-content">
        <!-- 当列表框中存在列表项时 -->
        <template v-if="specified_fields && specified_fields.length > 0">
          <template v-for="(field, index) in specified_fields">
            <!-- 单个列表项目 -->
            <div @click="selectItem(field, 'specified')" class="list-item specified-list-item" v-bind:key="'specified-list-item' + index" :class="field.selected ? 'selected': ''">
              <!-- 是可勾选的 -->
              <template v-if="field.checkable">
                <div class="list-item-prefix specified-list-item-prefix">
                  <Checkbox v-model="field.checked"></Checkbox>
                </div>
                <div class="list-item-label specified-list-item-label">{{field.label}}</div>
              </template>
              <!-- 不可勾选的 -->
              <template v-else>
                <div class="list-item-prefix specified-list-item-prefix">&nbsp;</div>
                <div class="list-item-label specified-list-item-label">{{field.label}}</div>
              </template>
            </div>
          </template>
        </template>
        <!-- 当列表框中不存在列表项时 -->
        <template v-else>
          <div class="no-list-item specified-no-list-item">
            <!-- {{$t('transfer.no_specified_fields_label')}} -->
            没有可用的已选字段
          </div>
        </template>
      </div>
    </div>

    <!-- 右侧下方的位移面板 -->
    <div class="position-change-panel">
      <!-- 上移 -->
      <Button size="small"
        :disabled="!(selected_specified_fields && selected_specified_fields.length > 0)"
        @click="moveUp">
        {{position_labels[0]}}
      </Button>
      <!-- 下移 -->
      <Button size="small"
        :disabled="!(selected_specified_fields && selected_specified_fields.length > 0)"
        @click="moveDown">
        {{position_labels[1]}}
      </Button>
    </div>
  </div>
</template>

<script>
export default {
  name: 'RTransfer',
  props: {
    available_fields: {
      type: Array,
      default () {
        return []
      }
    }, // 可用的备选字段数组
    specified_fields: {
      type: Array,
      default () {
        return []
      }
    }, // 已经设置的字段数组
    required_fields: {
      type: Array,
      default () {
        return []
      }
    }, // 必选字段
    list_titles: {
      type: Array,
      default () {
        return [
          // this.$t('transfer.available_fields_label'),
          // this.$t('transfer.specified_fields_label')
          '备选字段',
          '已选择字段'
        ]
      }
    }, // 标题集合，顺序从左至右
    position_labels: {
      type: Array,
      default () {
        return [
          // this.$t('transfer.move_up_label'),
          // this.$t('transfer.move_down_label'),
          '上移',
          '下移'
        ]
      }
    }, // 操作文案集合，顺序从上至下
    command_labels: {
      type: Object,
      default () {
        return {
          // reset: this.$t('transfer.reset_to_default'),
          // save: this.$t('transfer.save_btn_label')
          reset: '恢复默认设置',
          save: '保存',
        }
      }
    }
  },
  data () {
    return {
      checked_all_available_fields: false, // 是否选中全部备选项
      checked_all_specified_fields: false, // 是否选中全部已设置项
      checked_available_fields: [], // 勾选中的备选字段数组(用来移动)
      checked_specified_fields: [], // 勾选中的已设置字段数组(用来移动)
      selected_specified_fields: [], // 选中的已设置字段数组(用来排序)
      operation_labels: [
        // this.$t('transfer.move_to_left_label'),
        // this.$t('transfer.move_to_right_label')
        '< 移除',
        '添加 >'
      ],
      command_status: {
        reset: false,
        save: false
      }
    }
  },
  components: {
  },
  created () {
    this.getData()
  },
  watch: {
    value (newValue) {
      if (newValue) {
        this.getData()
        this.specified_fields.forEach((field) => {
          field.selected = false
          field.checked = false
        })
        this.available_fields.forEach((field) => {
          field.selected = false
          field.checked = false
        })
        this.checked_all_available_fields = false
        this.checked_all_specified_fields = false
        this.checked_available_fields = []
        this.checked_specified_fields = []
        this.command_status.save = false
        this.command_status.reset = false
      }
    }
  },
  methods: {
    // 获取数据
    getData () {
      // let _target_fields = this.data_cache.data_items[1].getOrRequestData()
      // this.formatData(_target_fields)
    },
    // 格式化取到的数据，合并成整体数组，并生成目标数组
    formatData (data) {
      if (data && data.value && data.value.specified_fields && data.value.available_fields) {
        let _data_value = data.value
        this.available_fields = this._formatItems(_data_value.available_fields)
        this.specified_fields = this._formatItems(_data_value.specified_fields)
      }
    },
    // 设置数据
    setData () {
      this.data_cache.data_items[1].setData({
        specified_fields: this.specified_fields.map((field) => {
          return {
            value: field.key,
            label: field.label
          }
        }),
        available_fields: this.available_fields.map((field) => {
          return {
            value: field.key,
            label: field.label
          }
        })
      })
    },
    // 格式化数据
    _formatItems (items) {
      if (items && items.length > 0) {
        return items.map((item) => {
          return {
            key: item.value,
            label: item.label,
            checkable: !this.required_fields.includes(item.value),
            selected: false,
            checked: false
          }
        })
      } else {
        return []
      }
    },
    // 列表项被点击选中/取消选中
    selectItem (item, list) {
      item.selected = !item.selected
      if (item.checkable) { 
        item.checked = !item.checked
      }
      this.refreshList(list)
    },
    // 全选列表
    checkAll (status, list) {
      if (list === 'available') {
        this.available_fields.forEach((field) => { 
          if (field.checkable) {
            field.checked = status
            field.selected = status
          }
        })
      } else if (list === 'specified') {
        this.specified_fields.forEach((field) => {
          if (field.checkable) {
            field.checked = status
            field.selected = status
          }
        })
      }
      this.refreshList(list)
    },
    // 从新更新列表
    refreshList (list) {
      let _list = []
      if (list === 'available') {
        this.available_fields.forEach((field) => {
          if (field.checkable && field.checked) { _list.push(field) }
        })
        this.checked_available_fields = _list
        let _checkable_list = this.available_fields.filter((field) => { return field.checkable })
        this.checked_all_available_fields = _checkable_list.length > 0 && _checkable_list.every((field) => { return field.checked })
      } else if (list === 'specified') {
        let _slist = []
        this.specified_fields.forEach((field) => {
          if (field.checkable && field.checked) { _list.push(field) }
          if (field.selected) { _slist.push(field) }
        })
        this.checked_specified_fields = _list
        this.selected_specified_fields = _slist
        let _checkable_list = this.specified_fields.filter((field) => { return field.checkable })
        this.checked_all_specified_fields = _checkable_list.length > 0 && _checkable_list.every((field) => { return field.checked })
      } else {
        this.checked_available_fields = []
        this.checked_specified_fields = []
        this.selected_specified_fields = []
        this.checked_all_available_fields = false
        this.checked_all_specified_fields = false
      }
    },
    // 上移
    moveUp () {
      this._movePosition('up')
    },
    // 下移
    moveDown () {
      this._movePosition('down')
    },
    // 位置列表
    _movePosition(direction) {
      if (direction === 'up') {
        for(let index = 0; index < this.specified_fields.length; index++) {
          if (this.specified_fields[index].selected && index > 0) {
            if (!(this.specified_fields[index - 1].selected)) {
              let temp = this.specified_fields[index - 1]
              this.specified_fields[index - 1] = this.specified_fields[index]
              this.specified_fields[index] = temp
            }
          }
        }
      } else if (direction === 'down') {
        for(let index = this.specified_fields.length - 1; index >= 0; index--) {
          if (this.specified_fields[index].selected && index < (this.specified_fields.length - 1)) {
            if (!(this.specified_fields[index + 1].selected)) {
              let temp = this.specified_fields[index + 1]
              this.specified_fields[index + 1] = this.specified_fields[index]
              this.specified_fields[index] = temp
            }
          }
        }
      } else {
        return null
      }
      this.refreshList('specified')
    },
    // 移除
    moveToLeft () {
      this._moveItems('to_left')
    },
    // 添加
    moveToRight () {
      this._moveItems('to_right')
    },
    // 移动列表
    _moveItems (direction) {
      let moveList = []
      let remainList = []
      let source_fields = null
      let target_fields = null
      if (direction === 'to_right') {
        source_fields = 'available_fields'
        target_fields = 'specified_fields'
      } else if (direction === 'to_left') {
        source_fields = 'specified_fields'
        target_fields = 'available_fields'
      } else {
        return null
      }
      this[source_fields].forEach((field) => { 
        if (field.checkable && field.checked) {
          field.selected = false
          field.checked = false
          moveList.push(field)
        } else {
          remainList.push(field)
        }
      })
      this[source_fields] = remainList
      this[target_fields] = this[target_fields].concat(moveList)
      this.refreshList('available')
      this.refreshList('specified')
    },
    // 保存设置
    saveSpecifedFields () {
      this.command_status.save = true
      this.command_status.reset = true
      this.$api.toolApis.projectListFields({ specified: this.specified_fields.map((field) => { return field.key }) }, this, (result) => {
        if (result.code >= 10000) {
          // 重新设置缓存
          this.setData()
          // 成功保存设置
          this.$Message.info(result.message)
          this.closeDialog()
        } else {
          this.$Message.error(result.message + ' #error:' + result.code)
        }
        this.command_status.save = false
        this.command_status.reset = false
      }, (result) => {
        this.$Message.error('error')
        this.command_status.save = false
        this.command_status.reset = false
        console.log(result)
      })
    },
    // 恢复默认设置
    resetToDefault () {
      this.command_status.save = true
      this.command_status.reset = true
      this.$api.toolApis.projectListFields({ default: 1 }, this, (result) => {
        if (result.code >= 10000) {
          // 清理并重置缓存
          let data_item = this.data_cache.data_items[1]
          data_item.removeData()
          data_item.setData(result.data)
          // 重新获取数据
          this.getData()
          // 成功保存设置
          this.$Message.info(result.message)
          this.closeDialog()
          this.command_status.save = false
          this.command_status.reset = false
        } else {
          this.$Message.error(result.message + ' #error:' + result.code)
          this.command_status.save = false
          this.command_status.reset = false
        }
      }, (result) => {
        this.$Message.error('error')
      })
    },
    // 关闭
    closeDialog () {
      this.$emit('closeDialog')
    }
  }
}
</script>
