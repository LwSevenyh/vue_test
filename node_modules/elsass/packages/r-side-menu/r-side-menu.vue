<template>
  <Layout class="r-side-menu-wrapper">
    <Sider collapsible :collapsed-width="6" :width="width" v-model="isCollapsed" @on-collapse="onCollapse">
      <Menu ref="menu" v-show="!isCollapsed" :active-name="activeName" width="auto" class="r-side-menu__menu">
        <template v-for="item in menuList">
          <template v-if="item.children && item.children.length === 1">
            <side-menu-item v-if="showChildren(item)" :key="`menu-${item.name}`" :parent-item="item" class="first-ivu-menu-item"></side-menu-item>
            <link-menu-item v-else 
              :name="getName(item, true)"
              :path="item.path"
              :type="item.type"
              :key="`menu-${item.children[0].name}`"
              class="first-ivu-menu-item">
              <span>{{ showTitle(item.children[0]) }}</span>
            </link-menu-item>
          </template>
          <template v-else>
            <side-menu-item v-if="showChildren(item)" :key="`menu-${item.name}`" :parent-item="item" class="first-ivu-menu-item"></side-menu-item>
            <link-menu-item v-else 
              :name="getName(item)"
              :path="item.path"
              :type="item.type"
              :key="`menu-${item.name}`"
              class="first-ivu-menu-item">
              <span>{{ showTitle(item) }}</span>
            </link-menu-item>
          </template>
        </template>
      </Menu>
      <template v-slot:trigger>
        <div v-show="!isCollapsed" class="ivu-layout-sider-trigger r-side-menu__trigger" :style="{width: width + 'px'}" @click="packUp">
          <span v-if="isFixed">收起</span>
          <span v-else>固定</span>
        </div>
      </template>
    </Sider>
    <Layout>
      <slot></slot>
    </Layout>
  </Layout>
</template>

<script>
import SideMenuItem from './side-menu-item.vue'
import LinkMenuItem from './link-menu-item.vue'
import mixin from './mixin'

const getUnion = (arr1, arr2) => {
  return Array.from(new Set([...arr1, ...arr2]))
}

export default {
  name: 'RSideMenu',
  mixins: [ mixin ],
  components: {
    SideMenuItem,
    LinkMenuItem
  },
  props: {
    width: {
      type: Number,
      default: 230
    },
    menuList: {
      type: Array,
      default () {
        return []
      }
    },
    collapsed: {
      type: Boolean,
      default: false
    },
    theme: {
      type: String,
      default: 'dark'
    },
    rootIconSize: {
      type: Number,
      default: 20
    },
    iconSize: {
      type: Number,
      default: 16
    },
    accordion: Boolean,
    activeName: {
      type: String,
      default: ''
    },
    openNames: {
      type: Array,
      default: () => []
    }
  },
  data () {
    return {
      openedNames: [],
      isCollapsed: this.collapsed,
      isFixed: !this.collapsed
    }
  },
  methods: {
    packUp () {
      if (this.isFixed) {
        this.isCollapsed = true
        this.isFixed = false
      } else {
        this.isCollapsed = false
        this.isFixed = true
      }
    },
    onMouseover(event) {
      if (this.isFixed) return
      this.isCollapsed = false
    },
    onMouseout(event) {
      if (this.isFixed) return
      this.isCollapsed = true
    },
    onCollapse(status) {
      if (this.isFixed) return

      this.$nextTick(() => {
        let siderDom = document.getElementsByClassName('ivu-layout-sider-collapsed')[0]
        let mainDom  = document.getElementsByClassName('ivu-layout-sider-children')[0]
        if (status) {
          siderDom.addEventListener('mouseover', this.onMouseover)
          mainDom.addEventListener('mouseout', this.onMouseout)
        } else {
          siderDom.removeEventListener('mouseover', this.onMouseover)
          mainDom.removeEventListener('mouseout', this.onMouseout)
        }
      })
    },
    handleSelect (name) {
      this.$emit('on-select', name)
    },
    getOpenedNamesByActiveName (name) {
      return this.$route.matched.map(item => item.name).filter(item => item !== name)
    },
    updateOpenName (name) {
      if (name === this.$config.homeName) this.openedNames = []
      else this.openedNames = this.getOpenedNamesByActiveName(name)
    }
  },
  watch: {
    activeName (name) {
      if (this.accordion) this.openedNames = this.getOpenedNamesByActiveName(name)
      else this.openedNames = getUnion(this.openedNames, this.getOpenedNamesByActiveName(name))
    },
    openNames (newNames) {
      this.openedNames = newNames
    },
    openedNames () {
      this.$nextTick(() => {
        this.$refs.menu.updateOpened()
      })
    },
  },
  mounted () {
    this.openedNames = getUnion(this.openedNames, this.getOpenedNamesByActiveName(name))
  }
}
</script>

<style lang="sass">
@import '../../packages/theme-chalk/main.sass'

.r-side-menu-wrapper
  height: 100%
  .ivu-menu-vertical.ivu-menu-light:after
    display: none
  .ivu-layout-sider
    background: $theme1-common-bg-color
    transition: all 0s ease-in-out 0s
  .ivu-layout-sider-collapsed
    background: $border-active-color
    cursor: pointer
  ul.r-side-menu__menu
    background: $theme1-common-bg-color
    .ivu-menu-submenu:hover
      @include menu_first_bg_hover_color
      box-shadow: 0px 2px 2px 0px #200F4A
    .ivu-menu-item:hover, .ivu-menu-item-active, .ivu-menu-item-active:not(.ivu-menu-submenu)
      @include menu_background_hover_color
      &.first-ivu-menu-item
        box-shadow: 0px 2px 2px 0px #200F4A
    .ivu-menu-item-active, .ivu-menu-item-active:not(.ivu-menu-submenu)
      position: relative
      &:after
        width: 8px
        height: 8px
        border: 2px solid $cycle-icon-color
        position: absolute
        top: calc(50% - 4px)
        left: 10px
        background-color: transparent
        border-radius: 4px
    .ivu-menu-item a, .ivu-menu-submenu-title
      font-size: 16px
      font-weight: bold
      letter-spacing: 2px
      @include menu_font_color
    .ivu-menu-submenu
      .ivu-menu .ivu-menu-item a, .ivu-menu .ivu-menu-submenu-title
        font-size: 14px
        font-weight: bold
        letter-space: 2px
        @include menu_font_color
    .ivu-menu-opened
      position: relative
      .ivu-menu-submenu-title
        background: $sider-opened-title-background
      .ivu-menu-submenu-has-parent-submenu .ivu-menu-submenu-title
        background: $sider-opened-background
        &:hover
          @include menu_first_bg_hover_color
      .ivu-menu-submenu-has-parent-submenu
        .ivu-menu-item
          padding-top: 8px
          padding-bottom: 8px
          @include menu_font_color
          &:hover
            @include menu_background_hover_color
    .ivu-menu-opened:after
      content: '';
      display: block;
      width: 6px;
      height: 100%;
      background: rgba(165,133,229,1);
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      z-index: 901;

  .r-side-menu__trigger
    position: absolute
    height: 28px
    line-height: 28px
    background: $sider-trigger-background
</style>


